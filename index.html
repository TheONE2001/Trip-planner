<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>行程可视化规划器 v2</title>
  <style>
    :root{--bg:#f7f7f8;--card:#ffffff;--muted:#6b7280;--accent:#9aa3ad;--shadow:0 8px 24px rgba(16,24,40,0.06)}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#111827;background:var(--bg)}
    .app{max-width:1200px;margin:28px auto;padding:22px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:18px;margin:0;color:#111827}
    .sub{color:var(--muted);font-size:13px}
    .toolbar{display:flex;gap:8px;align-items:center}
    button{border:0;background:#fff;padding:8px 12px;border-radius:10px;box-shadow:var(--shadow);cursor:pointer;font-size:13px}
    .btn-primary{background:linear-gradient(180deg,#fff,#f6f7f8);border:1px solid #e6e9ec}
    .btn-ghost{background:transparent;border:1px solid #e6e9ec}
    .btn-danger{background:transparent;border:1px solid #f3c6c6;color:#b91c1c}
    .layout{display:grid;grid-template-columns:420px 1fr;gap:18px}
    .panel{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow)}
    .section{margin-bottom:12px}
    .section h3{margin:0 0 8px 0;font-size:14px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    input[type=text],input[type=datetime-local],input[type=number],select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ec;font-size:13px}
    .list{max-height:180px;overflow:auto;margin-top:8px;border-radius:8px;border:1px dashed #eef2f5;padding:8px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfcfd);border:1px solid #f1f5f9;margin-bottom:8px}
    .item .meta{font-size:13px}
    .item .meta small{display:block;color:var(--muted);font-size:12px}
    .seq{background:#e5e7eb;border-radius:6px;padding:2px 6px;font-size:12px;margin-right:6px;color:#374151}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow);border:1px solid #eceff2}
    .card .top{display:flex;justify-content:space-between;align-items:flex-start}
    .price{font-weight:700;font-size:16px}
    .meta{color:var(--muted);font-size:13px;margin-top:8px}
    .actions{display:flex;gap:8px;margin-top:12px}
    .fav.active{background:#111827;color:#fff}
    footer{text-align:center;color:var(--muted);font-size:13px;margin-top:18px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>行程可视化规划器 v2</h1>
        <div class="sub">自动组合 · 修改支持 · 自动保存 · 中文界面</div>
      </div>
      <div class="toolbar">
        <button id="resetBtn" class="btn-ghost">重置页面</button>
        <button id="copyFavorites" class="btn-primary">复制收藏卡片</button>
      </div>
    </header>

    <div class="layout">
      <aside class="panel">
        <div class="section">
          <h3>出发方案</h3>
          <div class="form-grid">
            <input id="o_from" type="text" placeholder="出发地">
            <input id="o_to" type="text" placeholder="目的地">
            <input id="o_flight" type="text" placeholder="航班号">
            <input id="o_price" type="number" placeholder="价格">
            <input id="o_dep" type="datetime-local" placeholder="--:--">
            <input id="o_arr" type="datetime-local" placeholder="--:--">
            <select id="o_direct"><option value="1">直飞</option><option value="0">中转</option></select>
            <input id="o_stops" type="text" placeholder="中转地(可空)">
            <input id="o_note" type="text" placeholder="购票来源/备注" style="grid-column:1/3">
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="addOutbound" class="btn-primary">添加出发方案</button>
          </div>
          <div id="outList" class="list"></div>
        </div>

        <div class="section">
          <h3>返程方案</h3>
          <div class="form-grid">
            <input id="r_from" type="text" placeholder="出发地">
            <input id="r_to" type="text" placeholder="目的地">
            <input id="r_flight" type="text" placeholder="航班号">
            <input id="r_price" type="number" placeholder="价格">
            <input id="r_dep" type="datetime-local" placeholder="--:--">
            <input id="r_arr" type="datetime-local" placeholder="--:--">
            <select id="r_direct"><option value="1">直飞</option><option value="0">中转</option></select>
            <input id="r_stops" type="text" placeholder="中转地(可空)">
            <input id="r_note" type="text" placeholder="购票来源/备注" style="grid-column:1/3">
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="addReturn" class="btn-primary">添加返程方案</button>
          </div>
          <div id="retList" class="list"></div>
        </div>
      </aside>

      <main>
        <div class="panel">
          <div id="summary" class="meta">系统将自动生成往返组合。</div>
          <div id="cards" class="cards" style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px"></div>
        </div>
        <footer>修改、删除、添加操作后自动更新组合 · 数据自动保存（可撤销一次删除）</footer>
      </main>
    </div>
  </div>

  <script>
    const outList=document.getElementById('outList');
    const retList=document.getElementById('retList');
    const cards=document.getElementById('cards');
    const summary=document.getElementById('summary');

    let outbound=[],returns_=[],combos=[];let lastDeleted=null;

    function saveData(){localStorage.setItem('tripData',JSON.stringify({outbound,returns_}))}
    function loadData(){const d=localStorage.getItem('tripData');if(d){try{const j=JSON.parse(d);outbound=j.outbound||[];returns_=j.returns_||[];}catch{}}}

    function el(t,c){const e=document.createElement(t);if(c)e.className=c;return e}
    function parseDT(v){if(!v)return null;const d=new Date(v);return isNaN(d)?null:d}
    function daysBetween(a,b){if(!a||!b)return null;return Math.round((b-a)/(24*60*60*1000));}

    function renderOutList(){outList.innerHTML='';outbound.forEach((o,i)=>{
      const it=el('div','item');
      const meta=el('div','meta');meta.innerHTML=`<span class='seq'>#${i+1}</span><strong>${o.flight}</strong><small>${o.from}→${o.to}</small><small>¥${o.price} · ${o.direct?'直飞':'中转'}</small>`;
      const btns=el('div');
      const edit=el('button');edit.textContent='修改';edit.addEventListener('click',()=>editItem(outbound,i,renderOutList));
      const del=el('button');del.textContent='删除';del.addEventListener('click',()=>deleteItem(outbound,i,renderOutList));
      btns.append(edit,del);
      it.append(meta,btns);
      outList.appendChild(it);
    });renderCombos();saveData();}

    function renderRetList(){retList.innerHTML='';returns_.forEach((o,i)=>{
      const it=el('div','item');
      const meta=el('div','meta');meta.innerHTML=`<span class='seq'>#${i+1}</span><strong>${o.flight}</strong><small>${o.from}→${o.to}</small><small>¥${o.price} · ${o.direct?'直飞':'中转'}</small>`;
      const btns=el('div');
      const edit=el('button');edit.textContent='修改';edit.addEventListener('click',()=>editItem(returns_,i,renderRetList));
      const del=el('button');del.textContent='删除';del.addEventListener('click',()=>deleteItem(returns_,i,renderRetList));
      btns.append(edit,del);
      it.append(meta,btns);
      retList.appendChild(it);
    });renderCombos();saveData();}

    function editItem(list,idx,render){const d=list[idx];if(list===outbound){
      Object.entries(d).forEach(([k,v])=>{const id='o_'+k;if(document.getElementById(id))document.getElementById(id).value=(Array.isArray(v)?v.join(', '):v)||''});
      document.getElementById('addOutbound').textContent='保存修改';document.getElementById('addOutbound').onclick=()=>{
        list[idx]=collectForm('o_');render();document.getElementById('addOutbound').textContent='添加出发方案';document.getElementById('addOutbound').onclick=addOutbound;
      };
    }else{
      Object.entries(d).forEach(([k,v])=>{const id='r_'+k;if(document.getElementById(id))document.getElementById(id).value=(Array.isArray(v)?v.join(', '):v)||''});
      document.getElementById('addReturn').textContent='保存修改';document.getElementById('addReturn').onclick=()=>{
        list[idx]=collectForm('r_');render();document.getElementById('addReturn').textContent='添加返程方案';document.getElementById('addReturn').onclick=addReturn;
      };
    }}

    function deleteItem(list,idx,render){if(!confirm('确定要删除该方案吗？'))return;lastDeleted={list,idx,item:list[idx]};list.splice(idx,1);render();if(confirm('已删除。是否撤销？'))undoDelete();}
    function undoDelete(){if(lastDeleted){lastDeleted.list.splice(lastDeleted.idx,0,lastDeleted.item);renderOutList();renderRetList();lastDeleted=null;}}

    function collectForm(p){return{from:val(p+'from'),to:val(p+'to'),flight:val(p+'flight'),price:+val(p+'price')||0,dep:val(p+'dep'),arr:val(p+'arr'),direct:document.getElementById(p+'direct').value==='1',stops:(val(p+'stops')||'').split(',').map(s=>s.trim()).filter(Boolean),note:val(p+'note')}}
    function val(id){return document.getElementById(id).value.trim()}

    function addOutbound(){const o=collectForm('o_');if(!o.from||!o.to||!o.flight){alert('请至少填写出发地、目的地和航班号');return;}outbound.push(o);renderOutList();}
    function addReturn(){const o=collectForm('r_');if(!o.from||!o.to||!o.flight){alert('请至少填写出发地、目的地和航班号');return;}returns_.push(o);renderRetList();}

    document.getElementById('addOutbound').onclick=addOutbound;
    document.getElementById('addReturn').onclick=addReturn;

    function renderCombos(){combos=[];for(const o of outbound){for(const r of returns_){const oArr=parseDT(o.arr),rDep=parseDT(r.dep);const stay=daysBetween(oArr,rDep);const totalPrice=o.price+r.price;const totalStops=(o.stops.length||0)+(r.stops.length||0);const direct=o.direct&&r.direct;combos.push({out:o,ret:r,stay,totalPrice,totalStops,direct,fav:false});}}
      showCombos();}

    function showCombos(){cards.innerHTML='';if(!combos.length){summary.textContent='暂无组合。';return;}summary.textContent=`共 ${combos.length} 个组合`;
      combos.forEach(c=>{const card=el('div','card');card.innerHTML=`<div class='top'><div><strong>${c.out.flight}</strong> ⇢ <strong>${c.ret.flight}</strong></div><div class='price'>¥${c.totalPrice}</div></div><div class='meta'>停留 ${c.stay??'--'} 天 · 中转 ${c.totalStops} 次 · ${c.direct?'直飞':'含中转'}</div><div class='actions'></div>`;
        const fav=el('button','fav');fav.textContent='收藏';fav.onclick=()=>{c.fav=!c.fav;fav.classList.toggle('active');saveData();}
        const cp=el('button');cp.textContent='复制';cp.onclick=()=>copyCard(c);
        card.querySelector('.actions').append(fav,cp);
        cards.append(card);
      });}

    function copyCard(c){const t=`出发:${c.out.flight} ${c.out.from}→${c.out.to}\n返程:${c.ret.flight} ${c.ret.from}→${c.ret.to}\n总价:¥${c.totalPrice}`;navigator.clipboard.writeText(t);alert('已复制');}

    document.getElementById('copyFavorites').onclick=()=>{const f=combos.filter(x=>x.fav);if(!f.length)return alert('暂无收藏');navigator.clipboard.writeText(f.map(c=>`${c.out.flight} ${c.ret.flight} ¥${c.totalPrice}`).join('\n')).then(()=>alert('已复制收藏'));}

    document.getElementById('resetBtn').onclick=()=>{if(!confirm('确定清空所有数据？'))return;localStorage.removeItem('tripData');outbound=[];returns_=[];renderOutList();renderRetList();renderCombos();alert('已清空');}

    loadData();renderOutList();renderRetList();renderCombos();
  </script>
</body>
</html>
