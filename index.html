<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>行程规划器</title>
<style>
  body { font-family: "Microsoft YaHei", sans-serif; background: #f9f9f9; color: #333; margin: 0; padding: 20px; }
  h2 { margin-top: 0; }
  .container { max-width: 1000px; margin: auto; }
  .form-section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
  .form-section label { display: block; margin-top: 10px; font-weight: bold; }
  .form-section input, .form-section select { width: 100%; padding: 6px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
  .btn { display: inline-block; padding: 6px 12px; margin-top: 10px; border: none; border-radius: 4px; cursor: pointer; }
  .btn-add { background: #4caf50; color: white; }
  .btn-reset { background: #f44336; color: white; }
  .cards { display: flex; flex-wrap: wrap; gap: 10px; }
  .card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); width: 300px; position: relative; }
  .card-header { font-weight: bold; margin-bottom: 6px; }
  .card-detail { font-size: 14px; margin-bottom: 4px; }
  .card-buttons { display: flex; gap: 6px; margin-top: 6px; }
  .btn-card { flex: 1; padding: 4px; font-size: 13px; border-radius: 4px; cursor: pointer; }
  .btn-edit { background: #2196f3; color: #fff; }
  .btn-delete { background: #f44336; color: #fff; }
  .btn-copy { background: #ff9800; color: #fff; }
  .btn-fav { background: #9c27b0; color: #fff; }
  .notification { position: fixed; top: 20px; right: 20px; background: #333; color: #fff; padding: 10px 15px; border-radius: 4px; opacity: 0.9; display: none; z-index: 999; }
</style>
</head>
<body>
<div class="container">
  <h2>行程方案添加</h2>
  <div class="form-section">
    <label>出发地*</label>
    <input type="text" id="from" placeholder="请输入出发地">
    
    <label>目的地*</label>
    <input type="text" id="to" placeholder="请输入目的地">
    
    <label>出发日期*</label>
    <input type="text" id="departDate" placeholder="YYYY/MM/DD">
    
    <label>到达日期</label>
    <input type="text" id="arriveDate" placeholder="YYYY/MM/DD 或 --:--">
    
    <label>出发时间</label>
    <input type="text" id="departTime" placeholder="HH:MM 或 --:--">
    
    <label>价格*</label>
    <input type="number" id="price" placeholder="￥0" min="0">
    
    <label>航空公司</label>
    <input type="text" id="airline" placeholder="可选">
    
    <label>航班号</label>
    <input type="text" id="flightNumber" placeholder="可选">
    
    <label>是否直飞</label>
    <select id="directFlight">
      <option value="yes">直飞</option>
      <option value="no">中转</option>
    </select>
    
    <label id="transferLabel" style="display:none;">中转次数</label>
    <select id="transferCount" style="display:none;">
      <option value="1">1次</option>
      <option value="2">2次</option>
      <option value="3">3次</option>
    </select>
    
    <div id="transferDetails"></div>
    
    <button class="btn btn-add" id="addBtn">添加方案</button>
    <button class="btn btn-reset" id="resetBtn">清空所有</button>
  </div>
  
  <h2>往返方案组合</h2>
  <div class="cards" id="cardsContainer"></div>
</div>

<div class="notification" id="notification"></div>

<script>
const fromInput = document.getElementById('from');
const toInput = document.getElementById('to');
const departDateInput = document.getElementById('departDate');
const arriveDateInput = document.getElementById('arriveDate');
const departTimeInput = document.getElementById('departTime');
const priceInput = document.getElementById('price');
const airlineInput = document.getElementById('airline');
const flightNumberInput = document.getElementById('flightNumber');
const directFlightSelect = document.getElementById('directFlight');
const transferLabel = document.getElementById('transferLabel');
const transferCount = document.getElementById('transferCount');
const transferDetails = document.getElementById('transferDetails');
const addBtn = document.getElementById('addBtn');
const resetBtn = document.getElementById('resetBtn');
const cardsContainer = document.getElementById('cardsContainer');
const notification = document.getElementById('notification');

let plans = JSON.parse(localStorage.getItem('plans')||'[]');
let editIndex = null;

// 初始化默认日期为今天
function todayStr() {
  const d = new Date();
  return d.getFullYear()+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+String(d.getDate()).padStart(2,'0');
}
departDateInput.value = todayStr();

// 动态显示中转次数
directFlightSelect.addEventListener('change',()=>{
  if(directFlightSelect.value==='no'){
    transferLabel.style.display='block';
    transferCount.style.display='block';
  }else{
    transferLabel.style.display='none';
    transferCount.style.display='none';
    transferDetails.innerHTML='';
  }
});

// 生成中转输入
transferCount.addEventListener('change',()=>{
  let n = parseInt(transferCount.value);
  let html = '';
  for(let i=1;i<=n;i++){
    html += `<label>中转${i}地</label><input type="text" class="transferPlace" placeholder="中转地${i}">
             <label>对应航班号</label><input type="text" class="transferFlight" placeholder="可选">`;
  }
  transferDetails.innerHTML = html;
});

// 显示通知
function showNotification(msg){
  notification.innerText = msg;
  notification.style.display='block';
  setTimeout(()=>{notification.style.display='none'},2000);
}

// 添加或修改方案
function savePlan(){
  const from = fromInput.value.trim();
  const to = toInput.value.trim();
  const departDate = departDateInput.value.trim();
  const arriveDate = arriveDateInput.value.trim() || '--:--';
  const departTime = departTimeInput.value.trim() || '--:--';
  let price = parseFloat(priceInput.value);
  if(!from||!to||!departDate||isNaN(price)||price<0){ showNotification('请填写必填项并保证价格非负'); return;}
  if(!/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(departDate)){ showNotification('出发日期格式应为 yyyy/mm/dd'); return;}
  if(arriveDate!=='--:--' && !/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(arriveDate)){ showNotification('到达日期格式应为 yyyy/mm/dd 或 --:--'); return;}
  
  const airline = airlineInput.value.trim();
  const flightNumber = flightNumberInput.value.trim();
  const direct = directFlightSelect.value;
  const transfers = [];
  if(direct==='no'){
    const places = Array.from(document.getElementsByClassName('transferPlace')).map(x=>x.value.trim());
    const flights = Array.from(document.getElementsByClassName('transferFlight')).map(x=>x.value.trim());
    for(let i=0;i<places.length;i++){
      if(places[i]) transfers.push({place:places[i],flight:flights[i]});
    }
  }
  
  const plan = {from,to,departDate,arriveDate,departTime,price,airline,flightNumber,direct,transfers,fav:false};
  
  if(editIndex!==null){
    plans[editIndex]=plan;
    editIndex=null;
    addBtn.innerText='添加方案';
  }else{
    plans.push(plan);
  }
  
  localStorage.setItem('plans',JSON.stringify(plans));
  renderPlans();
  resetForm();
  showNotification('保存成功');
}

// 渲染卡片
function renderPlans(){
  cardsContainer.innerHTML='';
  plans.forEach((p,i)=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="card-header">${i+1}. ${p.from} → ${p.to} ￥${p.price}</div>
      <div class="card-detail">出发: ${p.departDate} ${p.departTime}</div>
      <div class="card-detail">到达: ${p.arriveDate}</div>
      ${p.airline?`<div class="card-detail">航空公司: ${p.airline}</div>`:''}
      ${p.flightNumber?`<div class="card-detail">航班号: ${p.flightNumber}</div>`:''}
      <div class="card-detail">${p.direct==='yes'?'直飞':'中转'+p.transfers.length+'次'}</div>
    `;
    if(p.transfers.length>0){
      p.transfers.forEach((t,j)=>{
        const div = document.createElement('div');
        div.className='card-detail';
        div.innerText = `中转${j+1}: ${t.place} ${t.flight?('航班号:'+t.flight):''}`;
        card.appendChild(div);
      });
    }
    
    const btnDiv = document.createElement('div'); btnDiv.className='card-buttons';
    const editBtn = document.createElement('button'); editBtn.className='btn-card btn-edit'; editBtn.innerText='修改';
    editBtn.onclick=()=>editPlan(i);
    const delBtn = document.createElement('button'); delBtn.className='btn-card btn-delete'; delBtn.innerText='删除';
    delBtn.onclick=()=>deletePlan(i);
    const copyBtn = document.createElement('button'); copyBtn.className='btn-card btn-copy'; copyBtn.innerText='复制';
    copyBtn.onclick=()=>copyPlan(p);
    const favBtn = document.createElement('button'); favBtn.className='btn-card btn-fav'; favBtn.innerText=p.fav?'已收藏':'收藏';
    favBtn.onclick=()=>toggleFav(i,favBtn);
    btnDiv.appendChild(editBtn); btnDiv.appendChild(delBtn); btnDiv.appendChild(copyBtn); btnDiv.appendChild(favBtn);
    card.appendChild(btnDiv);
    cardsContainer.appendChild(card);
  });
}

// 重置表单
function resetForm(){
  fromInput.value=''; toInput.value=''; departDateInput.value=todayStr(); arriveDateInput.value=''; departTimeInput.value=''; priceInput.value=''; airlineInput.value=''; flightNumberInput.value=''; directFlightSelect.value='yes'; transferLabel.style.display='none'; transferCount.style.display='none'; transferDetails.innerHTML=''; editIndex=null; addBtn.innerText='添加方案';
}

// 编辑方案
function editPlan(index){
  const p = plans[index];
  fromInput.value=p.from; toInput.value=p.to; departDateInput.value=p.departDate; arriveDateInput.value=p.arriveDate; departTimeInput.value=p.departTime; priceInput.value=p.price; airlineInput.value=p.airline; flightNumberInput.value=p.flightNumber; directFlightSelect.value=p.direct;
  if(p.direct==='no'){
    transferLabel.style.display='block'; transferCount.style.display='block'; transferCount.value=p.transfers.length; transferDetails.innerHTML='';
    let html='';
    p.transfers.forEach((t)=>{
      html += `<label>中转地</label><input type="text" class="transferPlace" value="${t.place}" placeholder="中转地">
               <label>对应航班号</label><input type="text" class="transferFlight" value="${t.flight}" placeholder="可选">`;
    });
    transferDetails.innerHTML=html;
  }
  editIndex=index;
  addBtn.innerText='保存修改';
}

// 删除方案
function deletePlan(index){
  if(confirm('确认删除该方案？')){
    plans.splice(index,1);
    localStorage.setItem('plans',JSON.stringify(plans));
    renderPlans();
  }
}

// 复制方案信息
function copyPlan(p){
  let text=`${p.from} → ${p.to} ￥${p.price}\n出发: ${p.departDate} ${p.departTime}\n到达: ${p.arriveDate}\n`;
  if(p.airline) text+=`航空公司: ${
